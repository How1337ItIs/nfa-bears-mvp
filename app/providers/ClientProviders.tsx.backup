'use client';

import dynamic from 'next/dynamic';
import { useState, useEffect } from 'react';
import { WagmiSetup } from './WagmiSetup';

const PrivySetup = dynamic(
  () => import('@privy-io/react-auth').then(mod => mod.PrivyProvider),
  { ssr: false }
);

const QueryClientProvider = dynamic(
  () => import('@tanstack/react-query').then(mod => mod.QueryClientProvider),
  { ssr: false }
);

const WagmiProvider = dynamic(
  () => import('@privy-io/wagmi').then(mod => mod.WagmiProvider),
  { ssr: false }
);

export function ClientProviders({ children }: { children: React.ReactNode }) {
  const [mounted, setMounted] = useState(false);
  const [config, setConfig] = useState<any>(null);

  useEffect(() => {
    const setup = async () => {
      const { createConfig } = await import('@privy-io/wagmi');
      const { http } = await import('wagmi');
      const { defineChain } = await import('viem');

      const berachainBepolia = defineChain({
        id: 80069,
        name: 'Berachain Bepolia',
        network: 'berachain-bepolia',
        nativeCurrency: {
          decimals: 18,
          name: 'BERA',
          symbol: 'BERA',
        },
        rpcUrls: {
          default: {
            http: [process.env.NEXT_PUBLIC_BEPOLIA_RPC || 'https://bepolia.rpc.berachain.com/'],
          },
          public: {
            http: [process.env.NEXT_PUBLIC_BEPOLIA_RPC || 'https://bepolia.rpc.berachain.com/'],
          },
        },
        blockExplorers: {
          default: {
            name: 'Berachain Explorer',
            url: 'https://bepolia.beratrail.io',
          },
        },
        testnet: true,
      });

      const wagmiConfig = createConfig({
        chains: [berachainBepolia],
        transports: {
          [berachainBepolia.id]: http(process.env.NEXT_PUBLIC_BEPOLIA_RPC || 'https://bepolia.rpc.berachain.com/')
        }
      });

      setConfig(wagmiConfig);
      setMounted(true);
    };

    setup();
  }, []);

  if (!mounted || !config) {
    return <>{children}</>;
  }

  return (
    <PrivySetup
      appId={process.env.NEXT_PUBLIC_PRIVY_APP_ID || ''}
      config={{
        loginMethods: ['email', 'wallet'],
        appearance: {
          theme: 'light',
          accentColor: '#676FFF',
          logo: 'https://your-logo-url.com/logo.png',
        },
        embeddedWallets: {
          createOnLogin: 'users-without-wallets',
        },
      }}
    >
      <QueryClientProvider client={new (require('@tanstack/react-query').QueryClient)()}>
        <WagmiSetup>
          {children}
        </WagmiSetup>
      </QueryClientProvider>
    </PrivySetup>
  );
}
